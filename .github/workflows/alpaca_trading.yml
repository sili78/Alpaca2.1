name: Alpaca Trading Bot (Hybrid Yahoo)

on:
  workflow_dispatch:  # Buton manual de Start
  schedule:
    # RuleazÄƒ la fiecare 15 minute
    # Luni-Vineri: 09:00 - 23:00 UTC (AcoperÄƒ Pre-Market, Market, After-Hours)
    - cron: "*/15 9-23 * * 1-5"
    # MarÈ›i-SÃ¢mbÄƒtÄƒ: 00:00 UTC (Ultima orÄƒ din After-Hours SUA)
    - cron: "*/15 0 * * 2-6"

permissions:
  contents: write # âš ï¸ CRITIC: Permite botului sÄƒ salveze memoria (state.json)

concurrency:
  group: alpaca-trading-gme
  cancel-in-progress: false

jobs:
  run-strategy:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      # 1. DescÄƒrcÄƒm codul din GitHub
      - name: Checkout Code
        uses: actions/checkout@v4

      # 2. InstalÄƒm Python
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      # 3. InstalÄƒm dependinÈ›ele (INCLUSIV YFINANCE)
      - name: Install Dependencies
        run: |
          pip install pandas numpy requests yfinance

      # 4. RulÄƒm Scriptul Python
      - name: Run Trading Bot
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_API_SECRET: ${{ secrets.ALPACA_API_SECRET }}
          # DacÄƒ URL-ul nu e setat Ã®n secrets, scriptul va folosi Paper implicit
          ALPACA_BASE_URL: ${{ secrets.ALPACA_BASE_URL }}
          TELEGRAM_TOKEN: ${{ secrets.TELEGRAM_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          # DacÄƒ nu existÄƒ fiÈ™ierul de memorie, Ã®l creÄƒm gol
          if [ ! -f state.json ]; then echo "{}" > state.json; fi
          
          # Pornim scriptul
          python tv_style_alpaca_flip.py \
            --symbol "GME" \
            --qty 250 \
            --state "./state.json"

      # 5. SALVÄ‚M MEMORIA (Commit & Push)
      # Asta asigurÄƒ cÄƒ botul È›ine minte ultima tranzacÈ›ie È™i nu cumpÄƒrÄƒ dublu
      - name: Save State (Commit)
        run: |
          git config --global user.name "Alpaca Bot"
          git config --global user.email "bot@alpaca.markets"
          
          # VerificÄƒm dacÄƒ s-a modificat fiÈ™ierul state.json
          if [[ -n $(git status -s state.json) ]]; then
            git add state.json
            git commit -m "ğŸ¤– Bot Memory Update [skip ci]"
            git push
            echo "âœ… Memoria a fost salvatÄƒ."
          else
            echo "ğŸ’¤ Nicio schimbare. Nu salvez nimic."
          fi

      # 6. CurÄƒÈ›enie AutomatÄƒ (PÄƒstreazÄƒ doar ultimele 10 log-uri ca sÄƒ nu aglomereze)
      - name: Delete Old Workflow Runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          retain_days: 0
          keep_minimum_runs: 10
